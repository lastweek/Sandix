obj-y := setup.o
obj-y += traps.o
obj-y += e820.o

# head file
extra-y := head_$(BITS).o

# linker script
extra-y += vmSandix.ld

# for debug
extra-y += traps.i

define sed-y
	"/^->/{s:->#\(.*\):/* \1 */:; \
	s:^->\([^ ]*\) [\$$#]*\([-0-9]*\) \(.*\):#define \1 \2 /* \3 */:; \
	s:^->\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; \
	s:->::; p;}"
endef

define filechk_offset
	(set -e; \
	 echo "#ifndef $2"; \
	 echo "#define $2"; \
	 echo "/*"; \
	 echo " * DO NOT MODIFY."; \
	 echo " *"; \
	 echo " * This file was generated by arch/x86/kernel/Makefile"; \
	 echo " */"; \
	 echo ""; \
	 sed -ne $(sed-y); \
	 echo ""; \
	 echo "#endif" )
endef

# It looks ugly to generate this file here, it should be generated
# before building the kernel. If doing that, we should compile
# asm-offset.c first. As you know, make can not handle this, it
# has a circular dependency.
#
# In this order, files that will use <asm/asm-offset.h> must be
# compiled after here. Currently, only kernel/entry/entry_32.S
# uses this header file. So it would be ok here...
#
# After all, coping the header file into the generated directory.
# Since all generated header files are sleeping there.

extra-y += asm-offset.s
extra-y += asm-offset.h

arch/x86/kernel/asm-offset.h: arch/x86/kernel/asm-offset.s FORCE
	$(call filechk,offset,_ASM_GENERATED_ASM_OFFSET_H_)
	@set -e
	@cp $@ include/generated/asm-offset.h
